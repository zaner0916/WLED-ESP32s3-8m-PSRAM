name: WLED-MM compile (ESP32-WROOM)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade platformio

      - name: Fetch MoonModules WLED (mdev)
        run: |
          set -euxo pipefail
          git clone --depth 1 --branch mdev https://github.com/MoonModules/WLED-MM.git /tmp/WLED-MM
          echo "/tmp/WLED-MM" > /tmp/WLED_DIR

      - name: Pick base env for ESP32-WROOM (4MB)
        id: envpick
        run: |
          set -euxo pipefail
          cd "$(cat /tmp/WLED_DIR)"
          if grep -q "^\[env:esp32_4MB_max\]" platformio.ini; then
            echo "BASE_ENV=esp32_4MB_max" >> $GITHUB_OUTPUT
          elif grep -q "^\[env:esp32dev\]" platformio.ini; then
            echo "BASE_ENV=esp32dev" >> $GITHUB_OUTPUT
          else
            echo "Could not find a suitable base env in platformio.ini"; exit 1
          fi

      - name: Add custom env for WROOM build (adds sdkconfig include paths)
        run: |
          set -euxo pipefail
          cd "$(cat /tmp/WLED_DIR)"
          BASE_ENV="${{ steps.envpick.outputs.BASE_ENV }}"

          # PlatformIO resolves ${platformio.packages_dir} to ~/.platformio/packages
          # Arduino-ESP32 places sdkconfig.h under tools/sdk/esp32/include/config
          SDKCFG_INC_1='-I${platformio.packages_dir}/framework-arduinoespressif32/tools/sdk/esp32/include'
          SDKCFG_INC_2='-I${platformio.packages_dir}/framework-arduinoespressif32/tools/sdk/esp32/include/config'

          {
            echo ""
            echo "[env:custom_wroom]"
            echo "extends = env:${BASE_ENV}"
            # Minimal overrides only; tweak LEDPIN if you want:
            echo "build_flags = \${env:${BASE_ENV}.build_flags} -D LEDPIN=16 ${SDKCFG_INC_1} ${SDKCFG_INC_2}"
            echo "lib_deps ="
            echo "  \${env:${BASE_ENV}.lib_deps}"
          } >> platformio.ini
          
      - name: Create shim sdkconfig.h (fallback)
        run: |
          set -euxo pipefail
          cd "$(cat /tmp/WLED_DIR)"
          mkdir -p include
          printf '#pragma once\n' > include/sdkconfig.h

      - name: Build firmware (custom_wroom)
        run: |
          set -euxo pipefail
          cd "$(cat /tmp/WLED_DIR)"
          pio run -e custom_wroom
          BIN=$(ls build_output/firmware/custom_wroom*.bin 2>/dev/null || true)
          if [ -z "$BIN" ]; then BIN=.pio/build/custom_wroom/firmware.bin; fi
          cp "$BIN" "$GITHUB_WORKSPACE/WLED-MM_custom_wroom.bin"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: WLED-MM_custom_wroom
          path: WLED-MM_custom_wroom.bin
